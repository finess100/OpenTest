#!/bin/bash
#echo "Objet $1 au rapport"

start=$(date +%s.%N)

objet_code=$1

echo "objet_code = $objet_code"

## Décomposition du code objet

regle_prix=0
regle_poids=0
regle_nom=""
regle_couleur=""
regle_id=""

fichier_objet=$(cat config/objets)

compteur_objet=0

for objet in $objet_code;do

	compteur_objet=$(($compteur_objet+1))

	objet_valeurs=$(cat config/objets | grep "id:$objet")

	#echo "id:$objet"
	#echo "$fichier_objet"
	#echo "objet_valeurs=$objet_valeurs"

	objet_id=$(echo $objet_valeurs | cut -d";" -f1 | cut -d":" -f2 )
	objet_nom=$(echo $objet_valeurs | cut -d";" -f2 | cut -d":" -f2 )
	objet_prix=$(echo $objet_valeurs | cut -d";" -f3 | cut -d":" -f2 )
	objet_poids=$(echo $objet_valeurs | cut -d";" -f4 | cut -d":" -f2 )
	objet_couleur=$(echo $objet_valeurs | cut -d";" -f5 | cut -d":" -f2 )

	#Calcul des règles

	regle_prix=$(($regle_prix+$objet_prix))
	regle_poids=$(($regle_poids+$objet_poids))
	regle_couleur="$regle_couleur $objet_couleur"
	regle_nom="$regle_nom $objet_nom"
	regle_id="$regle_id $objet_id"

done

#echo "En sortie : $regle_prix ~~ $regle_poids ~~ $regle_nom ~~~$regle_couleur ~~ $regle_id"


#~~ Calcul des règles

jackpot=false

# Le prix # Le poids # La couleur
./rules/prix.sh "$regle_id" "$regle_nom" "$regle_prix";./rules/poids.sh "$regle_id" "$regle_nom" "$regle_poids";./rules/couleur.sh "$regle_id" "$regle_nom" "$regle_couleur"

if [[ $? -eq 0 ]];then

objet_id=${1:-$regle_id}

echo -e "\e[92m`date +%s%N` [$objet_id] -> All rules OK\e[97m"
jackpot=true

fi

#~~ Essai : boucle de lancement des enfants


ligne_fichier_objet=$(sed -n '$=' config/objets)

ligne_fichier_objet=2

#echo $ligne_fichier_objet

#echo "compteur_objet = $compteur_objet"

if [[ $compteur_objet == $ligne_fichier_objet ]];then

	exit 0
	
	else 

	for objet in $fichier_objet;do

		#echo "regle_id = $regle_id"

		objet_enfant_id=$(echo $objet | cut -d";" -f1 | cut -d":" -f2 )
		
		test_si_deja_existant=$(echo $regle_id | grep "$objet_enfant_id" | wc -l)
		
		if [[ $jackpot ]];then
		
			if [[ $test_si_deja_existant -eq 0 ]];then
			
				if [[ $regle_id < $(echo $regle_id | rev) ]];then

				./template/dimension "$regle_id $objet_enfant_id" &
				
				fi
			fi
		
		fi

	done

	fi

runtime=$(echo "$(date +%s.%N) - $start" | bc)
echo "Runtime template dimension $objet_code: $runtime"
